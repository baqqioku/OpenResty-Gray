upstream driverAppFront {
        server 172.18.5.29:18950;
}

upstream driverAppFront-gray {
       server 172.18.5.29:18950;
}

upstream gpsAppFront {
        server 172.18.5.29:18940;
}

upstream driverOrderAppFront {
        server 172.18.5.29:18970;
}

upstream driverAppGateway {
        server 172.18.5.27:8500;
}


server {
        listen       8500;
        server_name  driverGateway-dev1.wsecar.com;



        set $redis_host '172.18.4.28';
        set $redis_port '6379';
        set $redis_auth  'Yq0wHk5AmlpJ0lEleO5zsMNN6npXOQ';
        #set $redis_uds '/tmp/redis.sock';
        set $redis_connect_timeout 5000;
        set $redis_dbid 0;

        set $redis_pool_size 1000;
        set $redis_keepalive_timeout 90000;

        location ~ ^/(driver|finance|message|recommend|trafficTrip|driverCenter|app|im|mapService|safeCenter|carSupplier) {
                access_log  logs/driverGateway-dev1.wsecar.com.log  main;
                proxy_redirect  off;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                client_max_body_size 30M;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                set $hostkey $server_name;
                set $sysConfig api_abc_sysConfig;
                set $kv_upstream kv_api_abc_upstream;
                set $kv_gray kv_api_grayServer;
                set $backend 'driverAppFront';
                rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
                proxy_pass http://$backend;


        }

        location =/mapService/exp/uploadGps {
                        proxy_redirect  off;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header Host $http_host;
                        client_max_body_size 30M;
                        proxy_http_version 1.1;
                        proxy_set_header Connection "";
                        proxy_pass http://gpsAppFront;
        }

        location =/mapService/taxi/uploadGps {
                        proxy_redirect  off;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header Host $http_host;
                        client_max_body_size 30M;
                        proxy_http_version 1.1;
                        proxy_set_header Connection "";
                        proxy_pass http://gpsAppFront;
        }

        location /carOrder {
                        proxy_redirect  off;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header Host $http_host;
                        client_max_body_size 30M;
                        proxy_http_version 1.1;
                        proxy_set_header Connection "";
                        proxy_pass http://driverOrderAppFront;
        }

        location  ~ ^/(carLife|driving) {
                        proxy_redirect  off;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header Host $http_host;
                        client_max_body_size 30M;
                        proxy_http_version 1.1;
                        proxy_set_header Connection "";
                        proxy_pass http://driverAppGateway;
        }

    }


server {
        listen       8501 ssl;
        server_name  driverGateway-dev1.wsecar.com;

        ssl_certificate  ssl/wsecar.com.pem;
        ssl_certificate_key   ssl/wsecar.com.key;
        ssl_session_timeout 5m;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_prefer_server_ciphers on;

        proxy_redirect  off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        client_max_body_size 30M;
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        set $redis_host '172.18.4.28';
        set $redis_port '6379';
        set $redis_auth  'Yq0wHk5AmlpJ0lEleO5zsMNN6npXOQ';
        #set $redis_uds '/tmp/redis.sock';
        set $redis_connect_timeout 5000;
        set $redis_dbid 0;
        set $redis_pool_size 1000;
        set $redis_keepalive_timeout 90000;

	#if ($document_uri ~ carLife){
	#	rewrite ^ https://carlifegateway-dev.wsecar.com/carLife permanent;
	#}

        location ~ ^/(driver|finance|message|recommend|trafficTrip|driverCenter|app|im|mapService|safeCenter|carSupplier) {
                        access_log  logs/driverGateway-dev1.wsecar.com.log  main;
                        set $hostkey $server_name;
                        set $sysConfig api_abc_sysConfig;
                        set $kv_upstream kv_api_abc_upstream;
                        set $kv_gray kv_api_grayServer;
                        set $backend 'driverAppFront';
                        rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
                        proxy_pass http://$backend;
        }

        location =/mapService/exp/uploadGps {
                        proxy_redirect  off;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header Host $http_host;
                        client_max_body_size 30M;
                        proxy_http_version 1.1;
                        proxy_set_header Connection "";
                        proxy_pass http://gpsAppFront;
        }

        location =/mapService/taxi/uploadGps {
                        proxy_redirect  off;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header Host $http_host;
                        client_max_body_size 30M;
                        proxy_http_version 1.1;
                        proxy_set_header Connection "";
                        proxy_pass http://gpsAppFront;
        }

        location /carOrder {
                        proxy_redirect  off;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header Host $http_host;
                        client_max_body_size 30M;
                        proxy_http_version 1.1;
                        proxy_set_header Connection "";
                        proxy_pass http://driverOrderAppFront;
        }        

        location  ~ ^/(carLife|driving) {
                        proxy_redirect  off;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header Host $http_host;
                        client_max_body_size 30M;
                        proxy_http_version 1.1;
                        proxy_set_header Connection "";
                        proxy_pass http://driverAppGateway;
        }        

    }

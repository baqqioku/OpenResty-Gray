
upstream driverAppFront {
        server 172.18.5.103:18950;
}

upstream driverAppFront-gray {
        server 172.18.5.107:18950;
}

upstream gpsAppFront {
        server 172.18.5.104:18940;
        server 172.18.5.103:18947;
}

upstream gpsAppFront-gray {
        server 172.18.5.107:18940;
}

upstream driverOrderAppFront {
        server 172.18.5.103:18970;
}

upstream driverOrderAppFront-gray {
        server 172.18.5.107:18970;
}

upstream driverAppGateway {
        server 172.18.5.102:8500;
}

upstream driverFileAppFront {
        server 172.18.5.105:19000;
}


server {
        listen       8500;
        server_name  driverGateway-uat.wsecar.com;
        access_log logs/driverGateway-uat.wsecar.com_access.log  main;
        error_log  logs/driverGateway-uat.wsecar.com_error.log debug;
        proxy_redirect  off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        client_max_body_size 30M;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        #设置缓存字典过期时间 单位 s
        #set $shdict_expire 60;

        set $redis_host '172.18.5.110';
        set $redis_port '6379';
        set $redis_auth  'Yq0wHk5AmlpJ0lEleO5zsMNN6npXOQ';
        #set $redis_uds '/tmp/redis.sock';
        set $redis_connect_timeout 3000;
        set $redis_dbid 0;
        set $redis_pool_size 2000;
        set $redis_keepalive_timeout 90000;


         set $sysConfig api_abc_sysConfig;
         set $kv_upstream kv_api_abc_upstream;
         set $kv_gray kv_api_grayServer;


         location = /healthCheck {
                         #设置content type
                         default_type text/html ;
                         # HTTP Status Code 和 内容
                         return 200  "hello world! ";
         }


        location ~ ^/(driver|finance|message|recommend|trafficTrip|driverCenter|app|im|mapService|safeCenter|carSupplier) {
                set $hostkey $server_name;
                set $backend 'driverAppFront';
                rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
                proxy_pass http://$backend;
        }

        location =/mapService/exp/uploadGps {
                set $hostkey uploadGps;
                set $backend 'gpsAppFront';
                rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
                proxy_pass http://$backend;
        }

        location =/mapService/taxi/uploadGps {
                set $hostkey uploadGps;
                set $backend 'gpsAppFront';
                rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
                proxy_pass http://$backend;

        }

        location /carOrder {
                set $hostkey carOrder;
                set $backend 'driverOrderAppFront';
                rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
                proxy_pass http://$backend;
        }

        location  ~ ^/(driving) {
                proxy_pass http://driverAppGateway;
        }

        location /carLife {
                proxy_pass https://carlifegateway-uat.wsecar.com:9801/carLife;
        }

        location /fileFront {
                proxy_redirect  off;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $http_host;
                client_max_body_size 100M;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_pass http://driverFileAppFront;
        }


    }


server {
        listen       8501 ssl;
        server_name  driverGateway-uat.wsecar.com;

        access_log logs/driverGateway-uat.wsecar.com_access.log  main;
        error_log  logs/driverGateway-uat.wsecar.com_error.log debug;

        ssl_certificate  ssl/wsecar.com.pem;
        ssl_certificate_key   ssl/wsecar.com.key;
        ssl_session_timeout 5m;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_prefer_server_ciphers on;

        proxy_redirect  off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        client_max_body_size 30M;
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        set $redis_host '172.18.4.28';
        set $redis_port '6379';
        set $redis_auth  'Yq0wHk5AmlpJ0lEleO5zsMNN6npXOQ';
        #set $redis_uds '/tmp/redis.sock';
        set $redis_connect_timeout 5000;
        set $redis_dbid 0;
        set $redis_pool_size 1000;
        set $redis_keepalive_timeout 90000;

	#if ($document_uri ~ carLife){
	#	rewrite ^ https://carlifegateway-dev.wsecar.com/carLife permanent;
	#}

        location ~ ^/(driver|finance|message|recommend|trafficTrip|driverCenter|app|im|mapService|safeCenter|carSupplier) {
                set $hostkey $server_name;
                set $sysConfig api_abc_sysConfig;
                set $kv_upstream kv_api_abc_upstream;
                set $kv_gray kv_api_grayServer;
                set $backend 'driverAppFront';
                rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
                proxy_pass http://$backend;
        }

        location =/mapService/exp/uploadGps {

                set $hostkey uploadGps;
                set $sysConfig api_abc_sysConfig;
                set $kv_upstream kv_api_abc_upstream;
                set $kv_gray kv_api_grayServer;
                set $backend 'gpsAppFront';
                rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
                proxy_pass http://$backend;
        }

        location =/mapService/taxi/uploadGps {
                set $hostkey uploadGps;
                set $sysConfig api_abc_sysConfig;
                set $kv_upstream kv_api_abc_upstream;
                set $kv_gray kv_api_grayServer;
                set $backend 'gpsAppFront';
                rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
                proxy_pass http://$backend;
        }

        location /carOrder {
                set $hostkey driverCarOrder;
                set $sysConfig api_abc_sysConfig;
                set $kv_upstream kv_api_abc_upstream;
                set $kv_gray kv_api_grayServer;
                set $backend 'driverOrderAppFront';
                rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
                proxy_pass http://$backend;
        }        

        location  ~ ^/(driving) {
                proxy_pass http://driverAppGateway;
        }

        location /carLife {
                proxy_pass https://carlifegateway-uat.wsecar.com:9801/carLife;
        }

          location /fileFront {
                    proxy_redirect  off;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header Host $http_host;
                    client_max_body_size 100M;
                    proxy_http_version 1.1;
                    proxy_set_header Connection "";
                    proxy_pass http://driverFileAppFront;
            }


    }

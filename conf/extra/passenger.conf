upstream passengerOrderAppFront {
        server 172.18.5.103:18980;
}

upstream passengerOrderAppFront-gray {
        server 172.18.5.107:18980;
}

upstream passengerGpsAppFront {
        #server 172.18.5.103:18947;
        server 172.18.5.104:18940;
}

upstream passengerGpsAppFront-gray {
        server 172.18.5.107:18947;
}

upstream passengerAppFront {
        server 172.18.5.103:18960;
}

upstream passengerAppFront-gray {
        server 172.18.5.107:18960;
}

upstream passengerAppGateway {
        server 172.18.5.102:8600;
}



server {
        listen       8600 reuseport;
        server_name  passengerGateway-uat.wsecar.com;
        access_log logs/passengerGateway-uat.wsecar.com_access.log  main;
        error_log  logs/passengerGateway-uat.wsecar.com_error.log error;
        proxy_redirect  off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        client_max_body_size 30M;
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        set $redis_host '172.18.4.28';
        set $redis_port '6379';
        set $redis_auth  'Yq0wHk5AmlpJ0lEleO5zsMNN6npXOQ';
        #set $redis_uds '/tmp/redis.sock';
        set $redis_connect_timeout 5000;
        set $redis_dbid 0;
        set $redis_pool_size 1000;
        set $redis_keepalive_timeout 90000;

        set $sysConfig api_abc_sysConfig;
        set $kv_upstream kv_api_abc_upstream;
        set $kv_gray kv_api_grayServer;

         location = /healthCheck {
                    #设置content type
                    default_type text/html ;
                    # HTTP Status Code 和 内容
                    return 200  "hello world! ";
        }


        location ~ ^/(passenger|app|user|im|mapService|chargingService|message|recommend|trafficTrip|safeCenter|activity) {
             set $hostkey 'passengerGateway-uat.wsecar.com';
             set $backend 'passengerAppFront';
             rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
             proxy_pass http://$backend;
        }

        location /carOrder {
              set $hostkey passengerCarOrder;
              set $backend 'passengerOrderAppFront';
              rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
              proxy_pass http://$backend;
        }

        location =/mapService/passenger/uploadGps {
              set $hostkey passengerUploadGps;
              set $backend 'passengerGpsAppFront';
              rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
              proxy_pass http://$backend;

        }

       location  ~ ^/(driving) {
               proxy_pass http://passengerAppGateway;
       }

       location /carLife {
               proxy_pass https://carlifegateway-uat.wsecar.com:9801/carLife;
       }

}


server {
        listen       8601 ssl reuseport;
        server_name  passengerGateway-uat.wsecar.com;
        access_log logs/passengerGateway-uat.wsecar.com_access.log  main;
        error_log  logs/passengerGateway-uat.wsecar.com_error.log error;

        ssl_certificate  ssl/wsecar.com.pem;
        ssl_certificate_key   ssl/wsecar.com.key;
        ssl_session_timeout 5m;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_prefer_server_ciphers on;

        proxy_redirect  off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        client_max_body_size 30M;
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        set $redis_host '172.18.4.28';
        set $redis_port '6379';
        set $redis_auth  'Yq0wHk5AmlpJ0lEleO5zsMNN6npXOQ';
        #set $redis_uds '/tmp/redis.sock';
        set $redis_connect_timeout 5000;
        set $redis_dbid 0;
        set $redis_pool_size 1000;
        set $redis_keepalive_timeout 90000;

        set $sysConfig api_abc_sysConfig;
        set $kv_upstream kv_api_abc_upstream;
        set $kv_gray kv_api_grayServer;



        location ~ ^/(passenger|app|user|im|mapService|chargingService|message|recommend|trafficTrip|safeCenter|activity) {
             set $hostkey 'passengerGateway-uat.wsecar.com';
             set $backend 'passengerAppFront';
             rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
             proxy_pass http://$backend;
        }

        location /carOrder {
            set $hostkey passengerCarOrder;
            set $backend 'passengerOrderAppFront';
            rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
            proxy_pass http://$backend;
        }

        location =/mapService/passenger/uploadGps {
            set $hostkey passengerUploadGps;
            set $backend 'passengerGpsAppFront';
            rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
            proxy_pass http://$backend;
        }

        location  ~ ^/(driving) {
             proxy_pass http://passengerAppGateway;
        }

        location /carLife {
            proxy_pass https://carlifegateway-uat.wsecar.com:9801/carLife;
        }

}

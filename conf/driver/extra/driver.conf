upstream driverAppFront {
        server 172.19.80.27:18950 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.80.30:18950 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.81.39:18950 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.81.40:18950 weight=100 max_fails=3 fail_timeout=10s;
        keepalive 200;
}

upstream driverAppFront-gray {
        server 172.19.95.8:18950 weight=100 max_fails=3 fail_timeout=10s;
        keepalive 200;
}

upstream gpsAppFront {
        server 172.19.81.43:18940 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.81.44:18940 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.80.21:18940 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.80.22:18940 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.80.23:18940 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.80.24:18940 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.80.25:18940 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.80.26:18940 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.81.106:18940 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.81.107:18940 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.81.108:18940 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.81.109:18940 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.81.110:18940 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.81.111:18940 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.81.112:18940 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.81.113:18940 weight=100 max_fails=3 fail_timeout=10s;
        keepalive 200;
}

upstream gpsAppFront-gray {
        server 172.19.95.12:18940 weight=100 max_fails=3 fail_timeout=10s;
        keepalive 200;
}


upstream driverOrderAppFront {
        server 172.19.80.249:18970 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.80.33:18970 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.81.45:18970 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.81.46:18970 weight=100 max_fails=3 fail_timeout=10s;
        keepalive 200;
}

upstream driverOrderAppFront-gray {
        server 172.19.95.10:18970 weight=100 max_fails=3 fail_timeout=10s;
        keepalive 200;
}

upstream driverAppGateway {
        server 172.19.80.28:8500 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.80.29:8500 weight=100 max_fails=3 fail_timeout=10s;
        keepalive 200;
}

upstream driverFileAppFront {
        server 172.19.81.56:19000 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.81.57:19000 weight=100 max_fails=3 fail_timeout=10s;
        keepalive 200;
}

upstream driverFileAppFrontImpl {
        server 172.19.81.56:19000 weight=100 max_fails=3 fail_timeout=10s;
        server 172.19.81.57:19000 weight=100 max_fails=3 fail_timeout=10s;
        keepalive 200;
}

server {
        listen       8500 reuseport;
        server_name  driverGateway.wsecar.com;
        access_log   logs/driverGateway.wsecar.com.log  main;
        error_log    logs/driverGateway.wsecar.com.error.log error;
        set $sysConfig api_abc_sysConfig;
        set $kv_upstream kv_api_abc_upstream;
        set $kv_gray kv_api_grayServer;

        set $redis_host '172.19.70.15';
        set $redis_port '6379';
        set $redis_auth  'VXTOrgIcDCFCy9MGz_qtyEtQh2sKYu';
        #set $redis_uds '/tmp/redis.sock';
        set $redis_dbid 0;
        set $redis_pool_size 20000;
        set $redis_idletime 90000;
        set $redis_connect_timeout 3000;


        location = /healthCheck {
            #设置content type
            default_type text/html ;
            # HTTP Status Code 和 内容
            return 200  "hello world! ";
        }

         location =/driver/exp/upgradeService {
                  #设置content type
                  default_type text/html ;
                  # HTTP Status Code 和 内容
                  return 404;
         }

        location ~ ^/(driver|finance|message|recommend|trafficTrip|driverCenter|app|im|mapService|safeCenter|carSupplier) {
             set $hostkey 'driverGateway.wsecar.com';
             set $backend 'driverAppFront';
             rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
             proxy_pass http://$backend;
        }

        location =/mapService/exp/uploadGps {
            set $hostkey driverUploadGps;
            set $backend 'gpsAppFront';
            rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
            proxy_pass http://$backend;
        }

        location =/mapService/taxi/uploadGps {
            set $hostkey driverUploadGps;
            set $backend 'gpsAppFront';
            rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
            proxy_pass http://$backend;
        }

        location /carOrder {
            set $hostkey driverCarOrder;
            set $backend 'driverOrderAppFront';
            rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
            proxy_pass http://$backend;
        }

        location /fileFront {
                   proxy_pass http://driverFileAppFront;
        }

        location  ~ ^/(driving) {
                  proxy_pass http://driverAppGateway;
        }

        location /carLife {
                  proxy_pass https://carlifegateway.wsecar.com:9801/carLife;
        }

    }


server {
        listen       8501 ssl reuseport;
        server_name  driverGateway.wsecar.com;
        access_log   logs/driverGateway.wsecar.com.log  main;
        error_log    logs/driverGateway.wsecar.com.error.log error;
        ssl_certificate  ssl/wsecar.com.pem;
        ssl_certificate_key   ssl/wsecar.com.key;
        ssl_session_timeout 5m;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_prefer_server_ciphers on;

        set $redis_host '172.19.70.15';
        set $redis_port '6379';
        set $redis_auth  'VXTOrgIcDCFCy9MGz_qtyEtQh2sKYu';
        #set $redis_uds '/tmp/redis.sock';
        set $redis_dbid 0;
        set $redis_pool_size 20000;
        set $redis_idletime 90000;
        set $redis_connect_timeout 3000;


        set $sysConfig api_abc_sysConfig;
        set $kv_upstream kv_api_abc_upstream;
        set $kv_gray kv_api_grayServer;


         location =/driver/exp/upgradeService {
                  #设置content type
                  default_type text/html ;
                  # HTTP Status Code 和 内容
                  return 404;
         }

        location ~ ^/(driver|finance|message|recommend|trafficTrip|driverCenter|app|im|mapService|safeCenter|carSupplier) {
            set $hostkey 'drivergateway.wsecar.com';
            set $backend 'driverAppFront';
            rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
            proxy_pass http://$backend;
        }

        location =/mapService/exp/uploadGps {
            set $hostkey driverUploadGps;
            set $backend 'gpsAppFront';
            rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
            proxy_pass http://$backend;
        }

        location =/mapService/taxi/uploadGps {
            set $hostkey driverUploadGps;
            set $backend 'gpsAppFront';
            rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
            proxy_pass http://$backend;
        }

        location /carOrder {
                set $hostkey driverCarOrder;
                set $backend 'driverOrderAppFront';
                rewrite_by_lua_file '/data/openresty/nginx/luacode/ab/diversion/diversion.lua';
                proxy_pass http://$backend;
        }

        location /fileFront {

               proxy_pass http://driverFileAppFront;
        }

        location  ~ ^/(driving) {
              proxy_pass http://driverAppGateway;
        }

        location /carLife {
               proxy_pass https://carlifegateway.wsecar.com:9801/carLife;
        }

    }

